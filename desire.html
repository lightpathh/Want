<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>欲の持続評価モデル</title>

<!-- Manifest (PWA) -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#7dd3fc">

<style>
  :root{
    --bg:#071226; --card:#07192a; --muted:#9fb4c7; --text:#e6eef8;
    --accent:#7dd3fc; --good:#38b000; --warn:#ffb020; --bad:#ef4444;
    --pill-bg: rgba(255,255,255,0.02);
  }
  html,body{height:100%}
  body{
    margin:0;padding:18px;background:linear-gradient(180deg,var(--bg) 0%, #04111a 100%);
    color:var(--text);font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    line-height:1.5;
  }
  .wrap{max-width:640px;margin:0 auto}
  header{margin-bottom:12px}
  h1{margin:0;font-size:1.3rem}
  .formula{color:var(--muted);font-size:0.92rem;margin-top:6px}
  main{display:flex;flex-direction:column;gap:14px}

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.03);padding:12px;border-radius:12px;
    box-shadow:0 6px 16px rgba(0,0,0,0.45);
  }

  label{display:block;color:var(--muted);font-size:0.92rem;margin-bottom:6px}
  input[type="number"], input[type="text"]{
    width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);
    background:rgba(255,255,255,0.02);color:var(--text);font-size:1rem;
    box-sizing:border-box;
  }

  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{border:0;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn-primary{background:var(--accent);color:#042029}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
  .btn-danger{background:var(--bad);color:#fff}
  .btn-small{padding:8px 10px;border-radius:8px;font-weight:700}

  .result-line{display:block;padding:12px;border-radius:10px;background:var(--pill-bg);margin-bottom:8px;font-weight:700}
  .result-value{float:right;font-weight:900}

  #judgeText{font-weight:900;display:inline-block;padding:6px 10px;border-radius:8px}

  .history-list{display:flex;flex-direction:column;gap:8px;max-height:320px;overflow:auto;margin-top:8px}
  .hist-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)}
  .hist-memo{font-weight:800;color:var(--text);flex:1;text-align:left}
  .hist-actions{display:flex;gap:8px;margin-left:10px}
  .hist-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:var(--text);font-weight:700}
  .hist-del{background:var(--bad);color:#fff;padding:8px;border-radius:8px;border:0;font-weight:700;cursor:pointer}

  .small-note{font-size:0.86rem;color:var(--muted)}
  footer{margin-top:18px;font-size:0.82rem;color:var(--muted);text-align:center;padding-bottom:26px}
  @media (max-width:480px){
    body{padding:12px}
    h1{font-size:1.1rem}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>欲の持続評価モデル</h1>
      <div class="formula">D = I × √T　　E' = D / (k × √C)</div>
    </header>

    <main>
      <!-- 入力 -->
      <section class="card" aria-labelledby="inputs">
        <div id="inputs">
          <label for="I">I（Intensity）: 欲の強度（1〜100）</label>
          <input id="I" type="number" inputmode="decimal" min="0" max="100" step="0.1" placeholder="例: 40" />

          <div style="height:10px"></div>

          <label for="T">T（Time, 日）: 持続日数</label>
          <input id="T" type="number" inputmode="numeric" min="1" max="10000" step="1" placeholder="例: 365" />

          <div style="height:10px"></div>

          <label for="C">C（Cost, 円）: 費用</label>
          <input id="C" type="number" inputmode="numeric" min="0" step="1" placeholder="例: 10000" />

          <div style="height:10px"></div>

          <label for="k">k（スケール定数）: （必須・手動可）</label>
          <input id="k" type="number" inputmode="decimal" min="0.0001" step="0.0001" placeholder="手動入力、または下で算出" />

          <div style="height:10px"></div>

          <label for="C0">衝動キャリブレーション C₀（円）: 衝動なら出して良い金額</label>
          <input id="C0" type="number" inputmode="numeric" min="1" step="1" placeholder="例: 5000" />

          <div class="controls">
            <button id="calcBtn" class="btn-primary">計算する</button>
            <button id="calcKBtn" class="btn-ghost btn-small">C₀ → k を算出</button>
            <button id="saveBtn" class="btn-ghost btn-small">履歴に保存</button>
            <button id="csvBtn" class="btn-ghost btn-small">CSV 出力</button>
          </div>
        </div>
      </section>

      <!-- 結果（恒常表示, 各一行） -->
      <section class="card" aria-labelledby="results">
        <div id="results">
          <div class="result-line">D（欲の総量） <span id="Dout" class="result-value">—</span></div>
          <div class="result-line">E'（主観的費用対効果） <span id="Eout" class="result-value">—</span></div>
          <div class="result-line">判定: <span id="judgeText" style="background:transparent;color:var(--muted)">—</span></div>
        </div>
      </section>

      <!-- 履歴 -->
      <section class="card" aria-labelledby="history">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <label class="small-note">履歴</label>
            <div class="small-note">保存したメモが太字で表示されます。メモをタップして読み込みできます。</div>
          </div>
          <div>
            <button id="clearBtn" class="btn-ghost btn-small">全件削除</button>
          </div>
        </div>

        <div class="history-list" id="historyList" aria-live="polite"></div>
      </section>
    </main>

    <footer>ダークモード · PWA対応</footer>
  </div>

<script>
/* ---------- Helpers ---------- */
const STORAGE_KEY = 'desire_model_history_v1';
function toNum(v){ const n = Number(v); return Number.isFinite(n) ? n : NaN; }
function r(v,dp=6){ const m=Math.pow(10,dp); return Math.round(v*m)/m; }
function nowISO(){ return new Date().toISOString(); }

/* ---------- DOM ---------- */
const Iel = document.getElementById('I');
const Tel = document.getElementById('T');
const Cel = document.getElementById('C');
const kel = document.getElementById('k');
const C0el = document.getElementById('C0');

const calcBtn = document.getElementById('calcBtn');
const calcKBtn = document.getElementById('calcKBtn');
const saveBtn = document.getElementById('saveBtn');
const csvBtn = document.getElementById('csvBtn');
const clearBtn = document.getElementById('clearBtn');

const Dout = document.getElementById('Dout');
const Eout = document.getElementById('Eout');
const judgeText = document.getElementById('judgeText');

const historyList = document.getElementById('historyList');

let lastComputed = null;

/* ---------- Calculation logic (explicit √T) ---------- */
function computeValues(I, T, C, k){
  if (!(I>0 && T>0 && C>0 && k>0)) {
    return { error: 'I,T,C,k は正の数で入力してください' };
  }
  const sqrtT = Math.sqrt(T);
  const D = I * sqrtT; // D = I × √T
  const sqrtC = Math.sqrt(C);
  const E = D / (k * sqrtC); // E' = D / (k × √C)
  return { D_raw: D, D: r(D,6), E_raw: E, E: r(E,6) };
}

/* ---------- Judgment ---------- */
function getJudgment(E){
  if (!Number.isFinite(E)) return { label: '—', color: 'var(--muted)' };
  if (E >= 3) return { label: '強く推奨', color: 'var(--good)' };
  if (E > 1) return { label: '良い', color: 'var(--good)' };
  if (E >= 0.7) return { label: '保留', color: 'var(--warn)' };
  return { label: '費用過剰', color: 'var(--bad)' };
}

/* ---------- UI updates ---------- */
function updateResultUI(res){
  if (!res || res.error){
    Dout.textContent = '—';
    Eout.textContent = '—';
    judgeText.textContent = (res && res.error) ? res.error : '—';
    judgeText.style.color = 'var(--muted)';
    lastComputed = null;
    return;
  }
  Dout.textContent = String(res.D);
  Eout.textContent = String(res.E);
  const j = getJudgment(res.E_raw);
  judgeText.textContent = j.label;
  judgeText.style.color = j.color;
  lastComputed = res;
}

/* ---------- Button actions ---------- */
calcBtn.addEventListener('click', ()=>{
  const I = toNum(Iel.value);
  const T = toNum(Tel.value);
  const C = toNum(Cel.value);
  const k = toNum(kel.value);
  if (!k || !Number.isFinite(k)) { alert('k は必須です。手動入力するか C₀ から算出してください。'); return; }
  const res = computeValues(I,T,C,k);
  updateResultUI(res);
});

calcKBtn.addEventListener('click', ()=>{
  const C0 = toNum(C0el.value);
  if (!C0 || C0 <= 0) { alert('C₀ に有効な金額を入力してください。例: 5000'); return; }
  const k = 100 / Math.sqrt(C0);
  kel.value = r(k,6);
  alert('k を算出して入力しました。k = ' + r(k,6));
});

/* ---------- History: store entries but visually show only memo (bold) ---------- */
function loadHistory(){
  try {
    const s = localStorage.getItem(STORAGE_KEY);
    if (!s) return [];
    const arr = JSON.parse(s);
    if (!Array.isArray(arr)) return [];
    return arr;
  } catch(e){ return []; }
}

function saveHistoryArray(arr){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
}

function renderHistory(){
  const arr = loadHistory();
  historyList.innerHTML = '';
  if (!arr || arr.length === 0){
    const p=document.createElement('div'); p.className='small-note'; p.textContent='履歴がありません。'; historyList.appendChild(p); return;
  }
  arr.forEach(entry => {
    const li = document.createElement('div'); li.className='hist-item';
    // Only show memo (bold) per requirement
    const memo = document.createElement('div'); memo.className='hist-memo'; memo.textContent = entry.memo;
    li.appendChild(memo);

    // Actions: 読み込み, 削除(赤)
    const actions = document.createElement('div'); actions.className='hist-actions';

    const loadBtn = document.createElement('button'); loadBtn.className='hist-btn'; loadBtn.textContent='読み込み';
    loadBtn.addEventListener('click', ()=>{
      // auto-fill inputs with stored values and compute automatically
      Iel.value = entry.I; Tel.value = entry.T; Cel.value = entry.C; kel.value = entry.k;
      const res = computeValues(entry.I, entry.T, entry.C, entry.k);
      updateResultUI(res);
      window.scrollTo({top:0,behavior:'smooth'});
    });

    const delBtn = document.createElement('button'); delBtn.className='hist-del'; delBtn.textContent='削除';
    delBtn.addEventListener('click', ()=>{
      if (!confirm('この履歴を削除しますか？')) return;
      deleteHistory(entry.id);
    });

    actions.appendChild(loadBtn); actions.appendChild(delBtn);
    li.appendChild(actions);
    historyList.appendChild(li);
  });
}

function addHistory(entry){
  const arr = loadHistory();
  arr.unshift(entry);
  while (arr.length > 200) arr.pop();
  saveHistoryArray(arr);
  renderHistory();
}

function deleteHistory(id){
  let arr = loadHistory();
  arr = arr.filter(e => e.id !== id);
  saveHistoryArray(arr);
  renderHistory();
}

/* ---------- Save current computed to history (with memo) ---------- */
saveBtn.addEventListener('click', ()=>{
  if (!lastComputed) { alert('まず「計算する」を押してから保存してください。'); return; }
  const memo = prompt('メモを入力（例: 欲しい物）', '');
  if (memo === null) return; // cancel
  const trimmed = String(memo).trim();
  if (trimmed.length === 0) { alert('メモは空にできません。例: 欲しい物'); return; }
  const entry = {
    id: 'h'+Date.now(),
    ts: nowISO(),
    I: toNum(Iel.value),
    T: toNum(Tel.value),
    C: toNum(Cel.value),
    k: toNum(kel.value),
    D: lastComputed.D,
    E: lastComputed.E,
    memo: trimmed
  };
  addHistory(entry);
  alert('履歴に保存しました。');
});

/* ---------- CSV export ---------- */
csvBtn.addEventListener('click', ()=>{
  const arr = loadHistory();
  if (!arr || arr.length === 0) { alert('エクスポートする履歴がありません。'); return; }
  const rows = [['ts','I','T','C','k','D','E','memo']];
  arr.forEach(e => rows.push([e.ts,e.I,e.T,e.C,e.k,e.D,e.E,e.memo]));
  const csv = rows.map(r => r.map(c => '"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'desire_model_history.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* ---------- Clear all ---------- */
clearBtn.addEventListener('click', ()=>{
  if (!confirm('履歴をすべて削除しますか？')) return;
  localStorage.removeItem(STORAGE_KEY);
  renderHistory();
});

/* ---------- Init ---------- */
(function init(){
  // Do not auto-calc; just render history and leave fields blank
  renderHistory();
  updateResultUI(null);
})();

/* ---------- Service Worker registration for PWA ---------- */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => console.log('ServiceWorker registered:', reg.scope))
      .catch(err => console.warn('ServiceWorker registration failed:', err));
  });
}
</script>
</body>
</html>