<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>欲の持続評価モデル — Desire Model (PWA)</title>

<!-- PWA manifest -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#7dd3fc" />
<link rel="icon" href="./icon-192.png" sizes="192x192" />
<!-- iOS support (optional) -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Desire Model">
<link rel="apple-touch-icon" href="./icon-192.png">

<style>
  :root{--bg:#071226;--card:#07182b;--accent:#7dd3fc;--muted:#94a3b8;--text:#e6eef8}
  html,body{height:100%}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,Arial;background:linear-gradient(180deg,#071226,#081426);color:var(--text);padding:20px;margin:0}
  .wrap{max-width:980px;margin:0 auto}
  header{display:flex;justify-content:space-between;align-items:center}
  h1{font-size:1.4rem;margin:0}
  .lead{color:var(--muted);margin:6px 0 18px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.6);margin-bottom:16px}
  label{display:block;font-size:0.9rem;color:var(--muted);margin-bottom:6px}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  input[type="number"], input[type="text"], select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--text);font-size:0.95rem}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{background:var(--accent);color:#042029;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
  .pill{background:rgba(255,255,255,0.02);padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  pre{background:rgba(0,0,0,0.25);padding:12px;border-radius:8px;overflow:auto;font-size:0.9rem}
  .small{font-size:0.85rem;color:var(--muted)}
  .history-list{max-height:180px;overflow:auto;margin-top:8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:6px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;font-size:0.9rem}
  .install-btn{background:#34d399;color:#042029;padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  @media (max-width:800px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>欲の持続評価モデル — Desire Model (PWA)</h1>
      <div class="lead">D = I × T^a ／ E' = D / (k × √C)。値を入れると自動計算・履歴保存・CSV 出力ができます。</div>
    </div>
    <div>
      <button id="promptInstall" class="install-btn" style="display:none">アプリをインストール</button>
    </div>
  </header>

  <section class="card">
    <div class="grid">
      <div>
        <label>I（Intensity）: 欲の強度（1〜100）</label>
        <input id="I" type="number" min="0" max="100" step="0.1" value="40" />
      </div>
      <div>
        <label>T（Time, 日）: 持続日数（1〜10000）</label>
        <input id="T" type="number" min="1" max="10000" step="1" value="365" />
      </div>

      <div>
        <label>C（Cost, 円）: 費用（円）</label>
        <input id="C" type="number" min="0" step="1" value="10000" />
      </div>
      <div>
        <label>k（スケール定数）: 手動入力または下でキャリブレーション</label>
        <input id="k" type="number" min="0.0001" step="0.0001" value="1.4142" />
      </div>

      <div>
        <label>時間指数 a（既定 0.5）: D = I × T^a</label>
        <input id="a" type="number" step="0.01" min="0.1" max="1" value="0.5" />
      </div>
      <div>
        <label>衝動キャリブレーション C₀（円）: 「衝動なら出して良い金額」</label>
        <input id="C0" type="number" min="1" step="1" placeholder="例: 5000 (空なら無視)" />
      </div>
    </div>

    <div class="controls">
      <button id="calcBtn">計算する</button>
      <button id="calibrateBtn" class="ghost">C₀ → k を計算</button>
      <button id="saveBtn" class="ghost">履歴に保存</button>
      <button id="exportCsv" class="ghost">CSV エクスポート</button>
      <button id="clearAll" class="ghost">履歴全消去</button>
    </div>
  </section>

  <section class="card">
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
      <div class="pill"><strong>D</strong> = <span id="Dout">—</span></div>
      <div class="pill"><strong>E'</strong> = <span id="Eout">—</span></div>
      <div class="pill"><strong>判定</strong> = <span id="judgement">—</span></div>
    </div>

    <div style="margin-top:12px">
      <label class="small">計算分解（確認用）</label>
      <pre id="breakdown">—</pre>
    </div>
  </section>

  <section class="card">
    <label class="small">履歴（ローカル保存）</label>
    <div style="display:flex;gap:8px;align-items:flex-end">
      <select id="historySelect" style="flex:1"><option value="">-- 履歴を選択 --</option></select>
      <button id="loadHistory" class="ghost">読み込み</button>
      <button id="deleteItem" class="ghost">選択項目を削除</button>
    </div>
    <div class="history-list" id="historyList"></div>
  </section>

  <footer style="margin-top:14px;color:var(--muted);font-size:0.9rem">
    <div>注意: PWA のインストールは HTTPS 配信が必要です（GitHub Pages など）。manifest.json と sw.js、icon-192.png / icon-512.png をルートに置いてください。</div>
  </footer>
</div>

<script>
/* ---------- ユーティリティ ---------- */
function toNumber(v){const n = Number(v); return Number.isFinite(n) ? n : NaN;}
function round(v, dp = 6){ const m = Math.pow(10, dp); return Math.round((v + Number.EPSILON) * m) / m;}

/* ---------- DOM ---------- */
const Iinput = document.getElementById('I');
const Tinput = document.getElementById('T');
const Cinput = document.getElementById('C');
const kinput = document.getElementById('k');
const ainput = document.getElementById('a');
const C0input = document.getElementById('C0');
const calcBtn = document.getElementById('calcBtn');
const calibrateBtn = document.getElementById('calibrateBtn');
const saveBtn = document.getElementById('saveBtn');
const Dout = document.getElementById('Dout');
const Eout = document.getElementById('Eout');
const breakdown = document.getElementById('breakdown');
const judgement = document.getElementById('judgement');
const historySelect = document.getElementById('historySelect');
const historyList = document.getElementById('historyList');
const loadHistory = document.getElementById('loadHistory');
const exportCsv = document.getElementById('exportCsv');
const deleteItem = document.getElementById('deleteItem');
const clearAll = document.getElementById('clearAll');
const promptInstallBtn = document.getElementById('promptInstall');

const STORAGE_KEY = 'desire_model_history_v2';

/* ---------- コア計算 ---------- */
function computeAll({I, T, C, k, a}) {
  if (!(I>0 && T>0 && C>=0 && k>0 && a>0)) {
    return {error:'入力に正の数を指定してください（Cは0以上）'};
  }
  const TpowA = Math.pow(T, a);
  const D = I * TpowA;
  const sqrtC = Math.sqrt(Math.max(C, 0));
  const denom = (k * sqrtC) || Number.EPSILON;
  const Eprime = D / denom;
  return {
    D_raw: D,
    D_display: round(D, 6),
    TpowA_display: round(TpowA, 8),
    sqrtC_display: round(sqrtC, 8),
    denom_display: round(denom, 8),
    Eprime_raw: Eprime,
    Eprime_display: Number.isFinite(Eprime) ? round(Eprime, 6) : '—'
  };
}

function judgementFromE(E) {
  if (!Number.isFinite(E)) return '計算不能';
  if (E >= 3) return "強く買い推奨 (E' ≥ 3)";
  if (E > 1) return "条件付きで買って良い (1 < E' < 3)";
  if (E >= 0.7) return "保留（再評価） (0.7 ≤ E' ≤ 1)";
  return "費用過剰 (E' < 0.7)";
}

/* ---------- UI 更新 ---------- */
function gatherInputs() {
  return {
    I: toNumber(Iinput.value),
    T: toNumber(Tinput.value),
    C: toNumber(Cinput.value),
    k: toNumber(kinput.value),
    a: toNumber(ainput.value)
  };
}

function updateUIWithResult(params, res) {
  if (res.error) {
    Dout.textContent = '—';
    Eout.textContent = '—';
    breakdown.textContent = 'エラー: ' + res.error;
    judgement.textContent = '—';
    return;
  }
  Dout.textContent = res.D_display + `（I=${params.I} × T^${params.a}）`;
  Eout.textContent = res.Eprime_display;
  judgement.textContent = judgementFromE(res.Eprime_raw);

  let s = '';
  s += '入力:\n';
  s += `  I = ${params.I}\n  T = ${params.T} 日\n  a = ${params.a}\n  C = ${params.C} 円\n  k = ${params.k}\n\n`;
  s += '計算:\n';
  s += `  1) T^a = ${params.T}^${params.a} = ${res.TpowA_display}\n`;
  s += `  2) D = I × T^a = ${params.I} × ${res.TpowA_display} = ${res.D_display}\n`;
  s += `  3) √C = √${params.C} = ${res.sqrtC_display}\n`;
  s += `  4) 分母 = k × √C = ${params.k} × ${res.sqrtC_display} = ${res.denom_display}\n`;
  s += `  5) E' = D / (k × √C) = ${res.D_display} / ${res.denom_display} = ${res.Eprime_display}\n\n`;
  s += `判定: ${judgementFromE(res.Eprime_raw)}\n\n`;
  s += 'メモ: D=100 は目安。k は個人差あり。C₀ でキャリブレーションして k を計算できます。\n';
  breakdown.textContent = s;
}

/* ---------- 履歴操作 ---------- */
function loadHistoryArray() {
  try {
    const s = localStorage.getItem(STORAGE_KEY);
    if (!s) return [];
    const arr = JSON.parse(s);
    if (!Array.isArray(arr)) return [];
    return arr;
  } catch (e) { return []; }
}

function saveHistoryArray(arr) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
}

function refreshHistoryUI() {
  const arr = loadHistoryArray();
  historySelect.innerHTML = '<option value="">-- 履歴を選択 --</option>';
  historyList.innerHTML = '';
  arr.forEach((ent) => {
    const opt = document.createElement('option');
    opt.value = ent.id;
    opt.textContent = `${ent.ts} — I=${ent.params.I}, T=${ent.params.T}, C=${ent.params.C}`;
    historySelect.appendChild(opt);

    const div = document.createElement('div');
    div.style.padding = '8px';
    div.style.borderBottom = '1px dashed rgba(255,255,255,0.02)';
    div.innerHTML = `<strong>${ent.ts}</strong><div class="small">I=${ent.params.I}, T=${ent.params.T}, C=${ent.params.C}, k=${ent.params.k}, a=${ent.params.a}</div>`;
    historyList.appendChild(div);
  });
}

/* ---------- イベントバインディング ---------- */
calcBtn.addEventListener('click', () => {
  const params = gatherInputs();
  const res = computeAll(params);
  updateUIWithResult(params, res);
});

calibrateBtn.addEventListener('click', () => {
  const C0 = toNumber(C0input.value);
  if (!C0 || C0 <= 0) { alert('C₀ に有効な金額を入力してください（例: 5000）'); return; }
  const k = 100 / Math.sqrt(C0);
  kinput.value = round(k, 6);
  // 自動で再計算
  calcBtn.click();
  alert('k をキャリブレーションしました: k = ' + round(k,6));
});

saveBtn.addEventListener('click', () => {
  const params = gatherInputs();
  if (!Number.isFinite(params.I) || !Number.isFinite(params.T) || !Number.isFinite(params.C) || !Number.isFinite(params.k) || !Number.isFinite(params.a)) {
    alert('入力値を確認してください。');
    return;
  }
  const res = computeAll(params);
  if (res.error) { alert(res.error); return; }
  const entry = {
    id: 'e' + Date.now(),
    ts: new Date().toISOString(),
    params, res
  };
  const arr = loadHistoryArray();
  arr.unshift(entry);
  while (arr.length > 200) arr.pop();
  saveHistoryArray(arr);
  refreshHistoryUI();
  alert('履歴に保存しました');
});

loadHistory.addEventListener('click', () => {
  const id = historySelect.value;
  if (!id) { alert('履歴を選択してください'); return; }
  const arr = loadHistoryArray();
  const ent = arr.find(e => e.id === id);
  if (!ent) { alert('選択した履歴が見つかりません'); return; }
  Iinput.value = ent.params.I;
  Tinput.value = ent.params.T;
  Cinput.value = ent.params.C;
  kinput.value = ent.params.k;
  ainput.value = ent.params.a;
  calcBtn.click();
});

deleteItem.addEventListener('click', () => {
  const id = historySelect.value;
  if (!id) { alert('削除する履歴を選択してください'); return; }
  if (!confirm('選択項目を削除しますか？')) return;
  let arr = loadHistoryArray();
  arr = arr.filter(e => e.id !== id);
  saveHistoryArray(arr);
  refreshHistoryUI();
});

clearAll.addEventListener('click', () => {
  if (!confirm('履歴をすべて消去しますか？')) return;
  localStorage.removeItem(STORAGE_KEY);
  refreshHistoryUI();
});

exportCsv.addEventListener('click', () => {
  const arr = loadHistoryArray();
  if (arr.length === 0) { alert('エクスポートする履歴がありません'); return; }
  const rows = [['ts','I','T','C','k','a','D','Eprime']];
  arr.forEach(e => {
    rows.push([
      e.ts,
      e.params.I,
      e.params.T,
      e.params.C,
      e.params.k,
      e.params.a,
      e.res ? e.res.D_display : '',
      e.res ? e.res.Eprime_display : ''
    ]);
  });
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'desire_history.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* ---------- 初期化 ---------- */
refreshHistoryUI();
calcBtn.click();

/* ---------- PWA: Service Worker 登録 & beforeinstallprompt ---------- */
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e) => {
  // デフォルトのインストールプロンプトを抑制して自前のボタンを表示
  e.preventDefault();
  deferredPrompt = e;
  promptInstallBtn.style.display = 'inline-block';
});

promptInstallBtn.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const choice = await deferredPrompt.userChoice;
  if (choice.outcome === 'accepted') {
    console.log('User accepted the install prompt');
  } else {
    console.log('User dismissed the install prompt');
  }
  deferredPrompt = null;
  promptInstallBtn.style.display = 'none';
});

// Service worker registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('./sw.js', {scope: './'});
      console.log('Service Worker registered, scope:', reg.scope);

      // optional: 新しい SW が有効になったら auto-refresh を促す（更新検知）
      reg.addEventListener('updatefound', () => {
        const newSW = reg.installing;
        newSW.addEventListener('statechange', () => {
          if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
            // 新しい内容がインストール済み（ページ更新で反映）
            console.log('Service Worker updated. A refresh may be needed.');
          }
        });
      });
    } catch (err) {
      console.error('Service Worker registration failed:', err);
    }
  });
}
</script>
</body>
</html>